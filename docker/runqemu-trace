#!/bin/bash

# Script to run the alpine-qemu container with instruction tracing
# This shows the instruction addresses as they execute

# Use absolute path to builtin directory to handle symlinks correctly
BUILTIN_DIR="/Users/iansmith/mazzy/docker/builtin"

# Verify builtin directory exists
if [ ! -d "$BUILTIN_DIR" ]; then
    echo "Error: builtin directory does not exist at $BUILTIN_DIR" >&2
    exit 1
fi

echo "Starting QEMU with instruction tracing enabled"
echo "This will show instruction addresses as they execute"
echo "Note: Only CPU 0 will execute (other CPUs are halted)"
echo "Press Ctrl+C to stop"
echo ""

# Run the container with instruction tracing
# -d exec: Show instruction addresses (less verbose than in_asm)
# Use 'exec,in_asm' for full disassembly (very verbose)
# Filter output to only show CPU 0 traces (CPUs 1-3 halt quickly)
TRACE_MODE="${TRACE_MODE:-exec}"
docker run --rm -it \
    -v "$BUILTIN_DIR:/mnt/builtin:ro" \
    alpine-qemu:3.22 \
    -d "$TRACE_MODE" \
    "$@" 2>&1 | grep --line-buffered "^Trace 0:"

