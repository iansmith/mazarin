#!/bin/bash

# Script to run QEMU directly on the host machine (not in Docker) with framebuffer display
# This is simpler for display testing since it doesn't require VNC or X11 forwarding
#
# Prerequisites:
#   - QEMU must be installed on the host: brew install qemu (on macOS)
#   - SDL2 must be installed: brew install sdl2 (on macOS)
#
# Usage:
#   docker/runqemu-host-fb

# Use absolute path to builtin directory
BUILTIN_DIR="/Users/iansmith/mazzy/docker/builtin"
KERNEL_ELF="$BUILTIN_DIR/kernel.elf"

# Verify kernel exists
if [ ! -f "$KERNEL_ELF" ]; then
    echo "Error: kernel.elf not found at $KERNEL_ELF" >&2
    echo "Please run 'cd src && make push' first to copy kernel.elf to docker/builtin/" >&2
    exit 1
fi

# Check if qemu-system-aarch64 is available
if ! command -v qemu-system-aarch64 &> /dev/null; then
    echo "Error: qemu-system-aarch64 not found" >&2
    echo "Install QEMU with: brew install qemu" >&2
    exit 1
fi

echo "Starting QEMU directly on host with SDL display"
echo "The framebuffer window will open on your desktop"
echo "Press Ctrl+C to stop QEMU"
echo ""

# Run QEMU directly on host with SDL display
# -display sdl: Use SDL for display (works on macOS, Linux, Windows)
# This will open a window on your desktop showing the framebuffer
qemu-system-aarch64 \
    -M raspi4b \
    -cpu cortex-a72 \
    -m 2G \
    -kernel "$KERNEL_ELF" \
    -append "console=ttyAMA0,115200 earlyprintk" \
    -serial stdio \
    -display sdl \
    -no-reboot \
    "$@"

