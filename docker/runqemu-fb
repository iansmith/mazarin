#!/bin/bash

# Script to run the alpine-qemu container with framebuffer display via VNC
# This script can be run from anywhere, including via symlinks
#
# Usage:
#   docker/runqemu-fb              # Use default VNC port 5900
#   VNC_PORT=5901 docker/runqemu-fb  # Use custom VNC port
#
# To view the display:
#   - macOS: Open Finder, press Cmd+K, enter: vnc://localhost:5900
#   - Or use a VNC client like "Screen Sharing" (built-in) or RealVNC Viewer
#   - Or use command: open vnc://localhost:5900

# Use absolute path to builtin directory to handle symlinks correctly
BUILTIN_DIR="/Users/iansmith/mazzy/docker/builtin"

# Verify builtin directory exists
if [ ! -d "$BUILTIN_DIR" ]; then
    echo "Error: builtin directory does not exist at $BUILTIN_DIR" >&2
    exit 1
fi

# VNC port (default 5900, which is VNC display :0)
# VNC ports are typically 5900 + display number (5900 = :0, 5901 = :1, etc.)
VNC_PORT="${VNC_PORT:-5900}"
VNC_DISPLAY=$((VNC_PORT - 5900))

echo "Starting QEMU with framebuffer display via VNC"
echo "VNC server will listen on port $VNC_PORT (display :$VNC_DISPLAY)"
echo "Port $VNC_PORT will be mapped from container to host"
echo ""
echo "IMPORTANT: macOS Screen Sharing has known compatibility issues with QEMU VNC"
echo "           and will likely hang or fail to connect."
echo ""
echo "RECOMMENDED: Use TigerVNC Viewer (if installed via Homebrew):"
echo "  vncviewer 127.0.0.1:$VNC_PORT"
echo ""
echo "Or if installed as an app:"
echo "  open -a 'TigerVNC Viewer 1.15.0' vnc://127.0.0.1:$VNC_PORT"
echo ""
echo "Alternative: RealVNC Viewer"
echo "  brew install --cask realvnc-viewer"
echo "  open -a 'VNC Viewer' vnc://127.0.0.1:$VNC_PORT"
echo ""
echo "If you want to try macOS Screen Sharing anyway:"
echo "  open vnc://127.0.0.1:$VNC_PORT"
echo "  (Note: It will likely hang or ask for password - this is a known issue)"
echo ""
echo "Press Ctrl+C to stop QEMU"
echo ""

# Run the container with VNC display enabled
# -serial stdio: Redirect UART output to console (so you see "Hello, Mazarin!" in terminal)
# -vnc 0.0.0.0:0,password=off: VNC server on all interfaces, display :0, NO password
#   Format: -vnc bind_address:display_number,password=off
#   Display :0 maps to port 5900, :1 to 5901, etc.
#   Note: macOS Screen Sharing has known compatibility issues with QEMU VNC
#   Use an alternative VNC client like RealVNC Viewer or TigerVNC
# -p $VNC_PORT:$VNC_PORT: Expose VNC port to host (maps container port to host port)
#   This makes the VNC server accessible on localhost:$VNC_PORT from the host machine
# Note: We bind to 0.0.0.0 inside container, Docker maps it to host's localhost
docker run --rm -it \
    -p "$VNC_PORT:$VNC_PORT" \
    -v "$BUILTIN_DIR:/mnt/builtin:ro" \
    --entrypoint qemu-system-aarch64 \
    alpine-qemu:3.22 \
    -M raspi4b \
    -kernel /mnt/builtin/kernel.elf \
    -append "console=ttyAMA0,115200 earlyprintk" \
    -serial stdio \
    -vnc "0.0.0.0:$VNC_DISPLAY,password=off" \
    -no-reboot \
    "$@"

