#!/bin/bash

# Script to run the alpine-qemu container with framebuffer display via VNC
# This script can be run from anywhere, including via symlinks
#
# Usage:
#   docker/runqemu-fb              # Use default VNC port 5900
#   VNC_PORT=5901 docker/runqemu-fb  # Use custom VNC port
#
# To view the display:
#   - macOS: Open Finder, press Cmd+K, enter: vnc://localhost:5900
#   - Or use a VNC client like "Screen Sharing" (built-in) or RealVNC Viewer
#   - Or use command: open vnc://localhost:5900

# Use absolute path to builtin directory to handle symlinks correctly
BUILTIN_DIR="/Users/iansmith/mazzy/docker/builtin"

# Verify builtin directory exists
if [ ! -d "$BUILTIN_DIR" ]; then
    echo "Error: builtin directory does not exist at $BUILTIN_DIR" >&2
    exit 1
fi

# VNC port (default 5900, which is VNC display :0)
# VNC ports are typically 5900 + display number (5900 = :0, 5901 = :1, etc.)
VNC_PORT="${VNC_PORT:-5900}"
VNC_DISPLAY=$((VNC_PORT - 5900))

# Clean up any existing mazarin-* containers (leftover from previous runs)
# timeout doesn't kill containers, so we need to clean them up manually
EXISTING_CONTAINERS=$(docker ps -a --format '{{.Names}}' 2>/dev/null | grep '^mazarin-' || true)
if [ -n "$EXISTING_CONTAINERS" ]; then
    echo "$EXISTING_CONTAINERS" | xargs docker kill 2>/dev/null || true
    echo "$EXISTING_CONTAINERS" | xargs docker rm 2>/dev/null || true
fi

# Generate unique container name: mazarin-<timestamp>-<random>
CONTAINER_NAME="mazarin-$(date +%s)-$$"

# Run the container with VNC display enabled
# -M virt: Use QEMU virt machine type (better UART compatibility than raspi4b)
# -cpu cortex-a72: Use Cortex-A72 CPU (same as Raspberry Pi 4)
# -m 512M: Allocate 512MB RAM
# -serial stdio: Redirect UART output to console (so you see "Hello, Mazarin!" in terminal)
# -vnc 0.0.0.0:0,password=off: VNC server on all interfaces, display :0, NO password
#   Format: -vnc bind_address:display_number,password=off
#   Display :0 maps to port 5900, :1 to 5901, etc.
#   Note: macOS Screen Sharing has known compatibility issues with QEMU VNC
#   Use an alternative VNC client like RealVNC Viewer or TigerVNC
# -p $VNC_PORT:$VNC_PORT: Expose VNC port to host (maps container port to host port)
#   This makes the VNC server accessible on localhost:$VNC_PORT from the host machine
# -semihosting: Enable semihosting for clean program exit
# Note: We bind to 0.0.0.0 inside container, Docker maps it to host's localhost
# Note: No -append flag needed for bare-metal kernels (that's for Linux kernels)
docker run --rm -i \
    --name "$CONTAINER_NAME" \
    -p "$VNC_PORT:$VNC_PORT" \
    -v "$BUILTIN_DIR:/mnt/builtin:ro" \
    --entrypoint qemu-system-aarch64 \
    alpine-qemu:3.22 \
    -M virt \
    -cpu cortex-a72 \
    -m 512M \
    -kernel /mnt/builtin/kernel.elf \
    -serial stdio \
    -semihosting \
    -vnc "0.0.0.0:$VNC_DISPLAY,password=off" \
    -no-reboot \
    "$@"

