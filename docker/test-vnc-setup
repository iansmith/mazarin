#!/bin/bash

# Test script to verify VNC framebuffer setup
# This script checks that all components are configured correctly

set -e  # Exit on error

echo "=========================================="
echo "VNC Framebuffer Setup Test"
echo "=========================================="
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print status
print_status() {
    if [ $1 -eq 0 ]; then
        echo -e "${GREEN}✓${NC} $2"
    else
        echo -e "${RED}✗${NC} $2"
    fi
}

# Check 1: Environment sourced
echo "1. Checking environment setup..."
if command -v runqemu-virt-vga &> /dev/null; then
    print_status 0 "runqemu-virt-vga found in PATH"
else
    print_status 1 "runqemu-virt-vga not in PATH"
    echo -e "   ${YELLOW}Fix: source /Users/iansmith/mazzy/enable-mazzy${NC}"
    exit 1
fi

# Check 2: Docker installed and running
echo ""
echo "2. Checking Docker..."
if command -v docker &> /dev/null; then
    print_status 0 "Docker installed"
    if docker ps &> /dev/null; then
        print_status 0 "Docker daemon running"
    else
        print_status 1 "Docker daemon not running"
        echo -e "   ${YELLOW}Fix: Start Docker Desktop${NC}"
        exit 1
    fi
else
    print_status 1 "Docker not installed"
    echo -e "   ${YELLOW}Fix: Install Docker Desktop${NC}"
    exit 1
fi

# Check 3: alpine-qemu image exists
echo ""
echo "3. Checking Docker image..."
if docker images | grep -q "alpine-qemu"; then
    print_status 0 "alpine-qemu:3.22 image exists"
else
    print_status 1 "alpine-qemu:3.22 image not found"
    echo -e "   ${YELLOW}Fix: Build image: cd docker && docker build -t alpine-qemu:3.22 .${NC}"
    exit 1
fi

# Check 4: Kernel built
echo ""
echo "4. Checking kernel..."
if [ -f "/Users/iansmith/mazzy/docker/builtin/kernel.elf" ]; then
    print_status 0 "kernel.elf exists in docker/builtin/"
else
    print_status 1 "kernel.elf not found in docker/builtin/"
    echo -e "   ${YELLOW}Fix: cd src && make kernel-qemu.elf && make push-qemu${NC}"
    exit 1
fi

# Check 5: Port 5900 available
echo ""
echo "5. Checking VNC port..."
if lsof -i :5900 &> /dev/null; then
    print_status 1 "Port 5900 is already in use"
    echo -e "   ${YELLOW}Info: Use VNC_PORT=5901 runqemu-virt-vga to use alternate port${NC}"
    echo ""
    echo "   Processes using port 5900:"
    lsof -i :5900 | head -5
else
    print_status 0 "Port 5900 is available"
fi

# Check 6: VNC client installed
echo ""
echo "6. Checking VNC client..."
VNC_CLIENT_FOUND=0
if command -v vncviewer &> /dev/null; then
    print_status 0 "vncviewer found (TigerVNC or similar)"
    VNC_CLIENT_FOUND=1
fi

if [ -d "/Applications/VNC Viewer.app" ]; then
    print_status 0 "RealVNC Viewer installed"
    VNC_CLIENT_FOUND=1
fi

if [ $VNC_CLIENT_FOUND -eq 0 ]; then
    print_status 1 "No compatible VNC client found"
    echo -e "   ${YELLOW}Recommended VNC clients:${NC}"
    echo "   - RealVNC Viewer: brew install --cask vnc-viewer"
    echo "   - TigerVNC: brew install tiger-vnc"
    echo ""
    echo -e "   ${RED}DO NOT USE Apple Screen Sharing - it has known compatibility issues${NC}"
    echo "   See: docs/qemu-vnc-framebuffer-setup.md"
fi

# Check 7: bochs-display in runqemu scripts
echo ""
echo "7. Checking QEMU configuration..."
if grep -q "bochs-display" /Users/iansmith/mazzy/docker/runqemu-virt-vga; then
    print_status 0 "runqemu-virt-vga has bochs-display device"
else
    print_status 1 "runqemu-virt-vga missing bochs-display device"
fi

if grep -q "bochs-display" /Users/iansmith/mazzy/docker/runqemu-fb; then
    print_status 0 "runqemu-fb has bochs-display device"
else
    print_status 1 "runqemu-fb missing bochs-display device"
fi

# Summary
echo ""
echo "=========================================="
echo "Summary"
echo "=========================================="
echo ""
echo "If all checks passed, you can now run:"
echo ""
echo -e "  ${GREEN}runqemu-virt-vga${NC}  # Start QEMU with VNC"
echo ""
echo "Then connect with VNC client:"
echo ""
if command -v vncviewer &> /dev/null; then
    echo -e "  ${GREEN}vncviewer localhost:5900${NC}"
fi
if [ -d "/Applications/VNC Viewer.app" ]; then
    echo -e "  ${GREEN}open -a 'VNC Viewer'${NC}  # Then enter: localhost:5900"
fi
echo ""
echo "Expected display: 640x480 window with kernel framebuffer"
echo ""
echo "Troubleshooting:"
echo "  - Check UART output for: 'findBochsDisplay: Found bochs-display device'"
echo "  - See: docs/qemu-vnc-framebuffer-setup.md"
echo "  - Quick reference: VNC-QUICKSTART.md"
echo ""













